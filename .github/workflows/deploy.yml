name: Deploy Strapi

on:
  push:
    branches:
      - master  # Trigger this workflow on push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.ASHOK_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.ASHOK_AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1  # Replace with your AWS region

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.ASHOK_EC2_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy Strapi Application
        run: |
          ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@${{ secrets.ASHOK_EC2_HOST }} << 'EOF'
            # Create the Strapi app if it doesn't exist
            if [ ! -d "~/my-strapi-project" ]; then
              yes | npx create-strapi-app@latest my-strapi-project --quickstart --skip-cloud --no-run
            fi

            cd ~/my-strapi-project

            # Initialize git if necessary and pull the latest changes
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/your-repo/your-strapi-project.git
            fi

            git fetch origin master
            git reset --hard origin/master 

            # Install dependencies and build the project
            yarn install 
            yarn build 
            
            # Start the Strapi app if not running, otherwise restart it
            if pm2 describe strapi-app > /dev/null; then
              pm2 restart strapi-app
            else
              pm2 start ./server.js --name strapi-app
            fi
          EOF
